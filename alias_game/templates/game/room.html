<!-- templates/game/room.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комната {{ room.id }} - Alias</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 20px;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 20px auto;
        }

        h1 {
            color: #1a73e8;
            margin-bottom: 20px;
            text-align: center;
        }

        .section-header {
            color: #1a73e8;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .room-info p {
            margin-bottom: 5px;
        }

        .scoreboard {
            margin-top: 20px;
        }

        .team-score-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .team-score-card.active-team {
            border-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.2);
        }

        .team-score-card h5 {
            margin-bottom: 10px;
            color: #1a73e8;
        }

        .explainer-ui {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            border: 2px dashed #1a73e8;
            border-radius: 10px;
            background-color: #e6f0ff;
        }

        .explainer-ui h2 {
            color: #0056b3;
            margin-bottom: 15px;
        }

        .word-display {
            font-size: 3em;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 20px;
        }

        .timer-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 20px;
        }

        .game-status-message {
            font-size: 1.2em;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #ffc10733;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .game-finished-message {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            background-color: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .btn-small-player-action {
            font-size: 0.8em;
            padding: 2px 5px;
        }
    </style>
</head>

<body>
    <div class="container" id="room-container" data-round-duration="{{ ROUND_DURATION_SECONDS|default:"60" }}">
        <h1>Alias Комната</h1>

        <div class="alert alert-info text-center" role="alert">
            ID Комнаты: <strong><span id="room-id-display">{{ room.id }}</span></strong>
            {% if is_creator %}
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyRoomId()">Копировать ID</button>
            {% endif %}
            <input type="hidden" id="telegram-user-id" value="{{ telegram_user_info.id }}">
            <input type="hidden" id="telegram-username" value="{{ telegram_user_info.username }}">
            <input type="hidden" id="my-player-id" value="{{ player.id }}">
            <input type="hidden" id="is-creator" value="{{ is_creator }}">
            {% csrf_token %}
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3 class="section-header">Настройки комнаты</h3>
                <div class="room-info">
                    <p>Создатель: <span id="creator-username">{{ room.creator_telegram_username }}</span></p>
                    <p>Сложность: <span id="room-difficulty">{{ room.get_difficulty_display }}</span></p>
                    <p>Очков для победы: <span id="winning-score">{{ room.winning_score }}</span></p>
                        <p>Штраф за пропуск: <span id="penalty-for-skip">{% if room.penalty_for_skip %}Да{% else %}Нет{% endif %}</span></p>
                </div>
            </div>
            <div class="col-md-6">
                <h3 class="section-header">Игроки</h3>
                <p>Всего игроков: <span id="players-in-room-count">...</span></p>
            </div>
        </div>

        <h3 class="section-header">Табло</h3>
        <div class="scoreboard row" id="scoreboard">
            <!-- Team scores will be rendered here by JS -->
        </div>

        <div id="game-info">
            <!-- Game status, current round, explainer info -->
            <p>Статус игры: <strong id="game-status-text">Ожидание игроков...</strong></p>
            <p>Раунд: <strong id="current-round">0</strong></p>
            <p>Следующая команда: <strong id="current-team-name">...</strong></p>
            <p>Объясняет: <strong id="current-explainer-username">...</strong></p>
        </div>

        <div id="game-finished" class="game-finished-message d-none">
            Игра завершена! Победила команда <span id="winning-team-name"></span>!
            {% if is_creator %}
            <div class="mt-3">
                <button class="btn btn-warning" onclick="resetGame()">Начать новую игру</button>
            </div>
            {% endif %}
        </div>

        <div id="game-waiting-state" class="text-center mt-4">
            <div class="game-status-message">
                Ожидаем начала игры. Игроки могут присоединиться и выбрать команды.
                Во всех командах должен быть хотя бы один игрок.
            </div>
            {% if is_creator %}
            <button class="btn btn-success btn-lg mt-3" id="startGameBtn" onclick="startGame()">Начать игру</button>
            <div id="startGameError" class="alert alert-danger mt-3 d-none"></div>
            {% endif %}
        </div>

        <div id="explainer-ui" class="explainer-ui d-none">
            <h2>Вы объясняете!</h2>
            <div id="current-word-container">
                <p>Ваше слово:</p>
                <div class="word-display" id="current-word">Жмите "СТАРТ"!</div>
            </div>

            <div class="timer-display" id="timer-display">00:00</div>

            <div id="explainer-actions" class="mt-3">
                <button class="btn btn-primary btn-lg" id="startRoundBtn" onclick="startRound()">СТАРТ</button>
                <button class="btn btn-success btn-lg d-none" id="guessedBtn"
                    onclick="handleWordAction('guessed')">Отгадано!</button>
                <button class="btn btn-warning btn-lg d-none" id="skipBtn"
                    onclick="handleWordAction('skip')">Пропустить</button>
            </div>
        </div>

        <div id="guesser-ui" class="text-center mt-4 d-none">
            <div class="game-status-message">
                Объясняет <strong id="guesser-explainer-name">...</strong> из команды <strong
                    id="guesser-explainer-team">...</strong>.
                <p>Таймер: <strong id="guesser-timer-display">00:00</strong></p>
            </div>
        </div>

    </div>

    <script>
        const roomId = "{{ room.id }}";
        const myTelegramUserId = document.getElementById('telegram-user-id').value;
        const myTelegramUsername = document.getElementById('telegram-username').value;
        const myPlayerId = document.getElementById('my-player-id').value;
        const isCreator = document.getElementById('is-creator').value === 'True';
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        const ROUND_DURATION_SECONDS = Number(document.getElementById('room-container').dataset.roundDuration) || 60;
        let gameUpdateInterval;
        let timerInterval;

        function copyRoomId() {
            const roomIdText = document.getElementById('room-id-display').textContent;
            navigator.clipboard.writeText(roomIdText).then(() => {
                alert('ID комнаты скопирован: ' + roomIdText);
            }).catch(err => {
                console.error('Не удалось скопировать текст: ', err);
            });
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay(seconds) {
            const formattedTime = formatTime(seconds);
            document.getElementById('timer-display').textContent = formattedTime;
            document.getElementById('guesser-timer-display').textContent = formattedTime;
        }

        function startClientTimer(initialTime) {
            let timeLeft = initialTime;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    // Оповещаем сервер, что таймер вышел (резервный вариант)
                    fetch(`/room/${roomId}/end_round_timer/`, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `tg_user_id=${myTelegramUserId}&tg_username=${myTelegramUsername}`
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(text => { throw new Error(text || response.statusText); });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Timer end signal sent to server:", data);
                            // После отправки сигнала, сразу же обновляем состояние, чтобы UI быстро изменился
                            getGameState();
                        })
                        .catch(error => console.error('Error sending timer end:', error));
                }
            }, 1000);
        }

        function renderGameState(state) {
            document.getElementById('game-status-text').textContent = state.status === 'waiting' ? 'Ожидание игроков' : (state.status === 'playing' ? 'Идет игра' : 'Игра завершена');
            document.getElementById('current-round').textContent = state.current_round;
            document.getElementById('current-team-name').textContent = state.current_team_name;
            document.getElementById('current-explainer-username').textContent = state.current_explainer_username;
            document.getElementById('players-in-room-count').textContent = state.players_in_room_count;

            // Scoreboard
            const scoreboardDiv = document.getElementById('scoreboard');
            scoreboardDiv.innerHTML = '';
            state.teams.forEach(team => {
                const teamCard = document.createElement('div');
                teamCard.className = `col-md-6 team-score-card ${state.current_team_name === team.name ? 'active-team' : ''}`;

                let playersHtml = team.players.map(p => `
                    <li>
                        ${p.telegram_username} 
                        ${p.id == myPlayerId ? '(Вы)' : ''}
                        ${p.telegram_username == state.current_explainer_username ? '(Объясняет)' : ''}
                        ${team.id === state.my_team_id && p.id == myPlayerId ? '<span class="text-success">(Ваша команда)</span>' : ''}
                        
                        <button class="btn btn-outline-info btn-sm btn-small-player-action ms-2" 
                                onclick="selectTeam('${team.id}')" 
                                ${team.id === state.my_team_id ? 'disabled' : ''}>
                                ${team.id === state.my_team_id ? 'В команде' : 'Присоединиться'}
                        </button>
                    </li>`).join('');

                let teamNameInputHtml = '';
                if (isCreator && state.status === 'waiting') { // Только создатель и только в режиме ожидания может менять названия
                    teamNameInputHtml = `
                        <div class="input-group input-group-sm mb-2">
                            <input type="text" class="form-control" id="team-name-${team.id}" value="${team.name}" maxlength="50">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateTeamName('${team.id}')">Изменить</button>
                        </div>
                    `;
                } else {
                    teamNameInputHtml = `<h5 class="mb-2">${team.name}</h5>`;
                }

                teamCard.innerHTML = `
                    ${teamNameInputHtml}
                    <p>Очки: <strong>${team.score}</strong></p>
                    <ul class="list-unstyled">
                        ${playersHtml}
                    </ul>
                `;
                scoreboardDiv.appendChild(teamCard);
            });

            // Game state specific UI
            const gameFinishedDiv = document.getElementById('game-finished');
            const gameWaitingStateDiv = document.getElementById('game-waiting-state');
            const explainerUiDiv = document.getElementById('explainer-ui');
            const guesserUiDiv = document.getElementById('guesser-ui');
            const startGameBtn = document.getElementById('startGameBtn');
            const startGameError = document.getElementById('startGameError');

            // Скрыть все по умолчанию
            gameFinishedDiv.classList.add('d-none');
            gameWaitingStateDiv.classList.add('d-none');
            explainerUiDiv.classList.add('d-none');
            guesserUiDiv.classList.add('d-none');

            if (state.game_finished) {
                gameFinishedDiv.classList.remove('d-none');
                document.getElementById('winning-team-name').textContent = state.winning_team_name;
                clearInterval(gameUpdateInterval); // Остановить обновление
                clearInterval(timerInterval); // Остановить таймер
                updateTimerDisplay(0); // Сбросить таймер
            } else if (state.status === 'waiting') {
                gameWaitingStateDiv.classList.remove('d-none');
                if (isCreator && state.players_in_room_count > 0 && state.players_in_room_count >= state.num_teams) {
                    startGameBtn.classList.remove('d-none');
                    startGameError.classList.add('d-none');
                } else if (isCreator) {
                    startGameBtn.classList.add('d-none');
                    startGameError.classList.remove('d-none');
                    if (state.players_in_room_count < state.num_teams) {
                        startGameError.textContent = `Необходимо хотя бы по одному игроку в каждой из ${state.num_teams} команд. Сейчас игроков: ${state.players_in_room_count}.`;
                    } else {
                        startGameError.textContent = `Чтобы начать игру, пригласите больше игроков и распределите по командам.`;
                    }
                }
                clearInterval(timerInterval); // Остановить таймер
                updateTimerDisplay(0);
            } else if (state.status === 'playing') {
                if (state.is_current_explainer) {
                    explainerUiDiv.classList.remove('d-none');
                    if (state.current_word) {
                        document.getElementById('current-word-container').style.display = 'block';
                        document.getElementById('current-word').textContent = state.current_word;
                        document.getElementById('startRoundBtn').classList.add('d-none');
                        document.getElementById('guessedBtn').classList.remove('d-none');
                        document.getElementById('skipBtn').classList.remove('d-none');
                        startClientTimer(state.time_remaining);
                    } else {
                        document.getElementById('current-word-container').style.display = 'none';
                        document.getElementById('current-word').textContent = 'Жмите "СТАРТ"!';
                        document.getElementById('startRoundBtn').classList.remove('d-none');
                        document.getElementById('guessedBtn').classList.add('d-none');
                        document.getElementById('skipBtn').classList.add('d-none');
                        clearInterval(timerInterval); // Остановить таймер
                        updateTimerDisplay(ROUND_DURATION_SECONDS); // Сброс таймера для нового раунда
                    }
                } else {
                    guesserUiDiv.classList.remove('d-none');
                    document.getElementById('guesser-explainer-name').textContent = state.current_explainer_username;
                    document.getElementById('guesser-explainer-team').textContent = state.current_team_name;
                    startClientTimer(state.time_remaining);
                }
            }
        }

        function getGameState() {
            fetch(`/room/${roomId}/state/?tg_user_id=${myTelegramUserId}&tg_username=${myTelegramUsername}`, { credentials: 'same-origin' })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    renderGameState(data);
                })
                .catch(error => console.error('Error fetching game state:', error));
        }

        function updateTeamName(teamId) {
            const newName = document.getElementById(`team-name-${teamId}`).value;
            if (!newName || newName.length < 2 || newName.length > 50) {
                alert('Имя команды должно быть от 2 до 50 символов.');
                return;
            }
            const formData = new FormData();
            formData.append('team_id', teamId);
            formData.append('new_name', newName);
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/update_team_name/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                    } else {
                        alert(data.message || 'Ошибка при обновлении имени команды.');
                    }
                })
                .catch(error => console.error('Error updating team name:', error));
        }

        function selectTeam(teamId) {
            const formData = new FormData();
            formData.append('team_id', teamId);
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/select_team/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                    } else {
                        alert(data.message || 'Ошибка при выборе команды.');
                    }
                })
                .catch(error => console.error('Error selecting team:', error));
        }

        function startGame() {
            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/start_game/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                    } else {
                        document.getElementById('startGameError').classList.remove('d-none');
                        document.getElementById('startGameError').textContent = data.message || 'Ошибка при начале игры.';
                    }
                })
                .catch(error => console.error('Error starting game:', error));
        }

        function startRound() {
            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/start_round/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                    } else {
                        alert(data.message || 'Ошибка при начале раунда.');
                    }
                })
                .catch(error => console.error('Error starting round:', error));
        }

        function handleWordAction(action) { // 'guessed' or 'skip'
            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/${action}/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        if (data.game_over) {
                            // Игра закончилась, просто обновить состояние
                            getGameState();
                        } else if (data.next_turn) {
                            // Слова закончились в раунде, сервер переключил ход
                            getGameState();
                        } else {
                            // Обычный ход, новое слово или текущее
                            getGameState();
                        }
                    } else {
                        alert(data.message || `Ошибка при выполнении действия "${action}".`);
                    }
                })
                .catch(error => console.error(`Error handling word action ${action}:`, error));
        }

        function resetGame() {
            if (!confirm('Вы уверены, что хотите сбросить игру и начать новую?')) {
                return;
            }
            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/reset_game/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                        clearInterval(gameUpdateInterval);
                        gameUpdateInterval = setInterval(getGameState, 2000); // Перезапустить интервал
                    } else {
                        alert(data.message || 'Ошибка при сбросе игры.');
                    }
                })
                .catch(error => console.error('Error resetting game:', error));
        }


        // Инициализация
        document.addEventListener('DOMContentLoaded', function () {
            getGameState(); // Получить начальное состояние
            gameUpdateInterval = setInterval(getGameState, 2000); // Обновлять каждые 2 секунды
        });
    </script>
</body>

</html>