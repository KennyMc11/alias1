<!-- templates/game/room.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комната {{ room.id }} - Alias</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 20px;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 20px auto;
        }

        h1 {
            color: #1a73e8;
            margin-bottom: 20px;
            text-align: center;
        }

        .section-header {
            color: #1a73e8;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .room-info p {
            margin-bottom: 5px;
        }

        .scoreboard {
            margin-top: 20px;
        }

        .team-score-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .team-score-card.active-team {
            border-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.2);
        }

        .team-score-card h5 {
            margin-bottom: 10px;
            color: #1a73e8;
        }

        .explainer-ui {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            border: 2px dashed #1a73e8;
            border-radius: 10px;
            background-color: #e6f0ff;
        }

        .explainer-ui h2 {
            color: #0056b3;
            margin-bottom: 15px;
        }

        .word-display {
            font-size: 3em;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 20px;
        }

        .timer-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 20px;
        }

        .game-status-message {
            font-size: 1.2em;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #ffc10733;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .game-finished-message {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            background-color: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .btn-small-player-action {
            font-size: 0.8em;
            padding: 2px 5px;
        }

        .team-name-display {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 10px;
        }

        .team-name-edit-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-team-edit {
            padding: 2px 8px;
            font-size: 0.8rem;
        }

        .team-selection-item {
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .team-selection-item:hover {
            background-color: #f8f9fa;
            border-left-color: #1a73e8;
            transform: translateX(5px);
        }

        .list-group-item.active-team {
            background-color: #e6f0ff;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        /* Стиль для игроков без команды */
        .player-without-team {
            opacity: 0.7;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container" id="room-container" data-round-duration="{{ ROUND_DURATION_SECONDS|default:" 60" }}">
        <h1>Alias Комната</h1>

        <div class="alert alert-info text-center" role="alert">
            ID Комнаты: <strong><span id="room-id-display">{{ room.id }}</span></strong>
            {% if is_creator %}
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyRoomId()">Копировать ID</button>
            {% endif %}
            <input type="hidden" id="telegram-user-id" value="{{ telegram_user_info.id }}">
            <input type="hidden" id="telegram-username" value="{{ telegram_user_info.username }}">
            <input type="hidden" id="my-player-id" value="{{ player.id }}">
            <input type="hidden" id="is-creator" value="{{ is_creator }}">
            {% csrf_token %}
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3 class="section-header">Настройки комнаты</h3>
                <div class="room-info">
                    <p>Создатель: <span id="creator-username">{{ room.creator_telegram_username }}</span></p>
                    <p>Сложность: <span id="room-difficulty">{{ room.get_difficulty_display }}</span></p>
                    <p>Очков для победы: <span id="winning-score">{{ room.winning_score }}</span></p>
                    <p>Штраф за пропуск: <span id="penalty-for-skip">{% if room.penalty_for_skip %}Да{% else
                            %}Нет{%endif %}</span></p>
                </div>
            </div>
            <div class="col-md-6">
                <h3 class="section-header">Игроки</h3>
                <p>Всего игроков: <span id="players-in-room-count">...</span></p>
            </div>
        </div>
        <div class="mt-4" id="players-without-team-container" style="display: none;">
            <h4 class="text-warning">Игроки без команды:</h4>
            <ul id="players-without-team-list" class="list-unstyled">
                <!-- Игроки без команды будут здесь -->
            </ul>
        </div>

        <!-- Модальное окно для выбора команды (для новых игроков) -->
        <div class="modal fade" id="teamSelectionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
            data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Выбор команды</h5>
                    </div>
                    <div class="modal-body">
                        <p>Добро пожаловать в комнату! Пожалуйста, выберите команду:</p>
                        <div id="team-selection-options" class="list-group">
                            <!-- Опции команд будут добавлены через JS -->
                        </div>
                        <div id="team-selection-error" class="alert alert-danger mt-3 d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <div class="text-muted small">Вы сможете сменить команду позже, пока игра не началась</div>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="section-header">Табло</h3>
        <div class="scoreboard row" id="scoreboard">
            <!-- Team scores will be rendered here by JS -->
        </div>

        <div id="game-info">
            <!-- Game status, current round, explainer info -->
            <p>Статус игры: <strong id="game-status-text">Ожидание игроков...</strong></p>
            <p>Раунд: <strong id="current-round">0</strong></p>
            <p>Следующая команда: <strong id="current-team-name">...</strong></p>
            <p>Объясняет: <strong id="current-explainer-username">...</strong></p>
        </div>

        <div id="game-finished" class="game-finished-message d-none">
            Игра завершена! Победила команда <span id="winning-team-name"></span>!
            {% if is_creator %}
            <div class="mt-3">
                <button class="btn btn-warning" onclick="resetGame()">Начать новую игру</button>
            </div>
            {% endif %}
        </div>

        <div id="game-waiting-state" class="text-center mt-4">
            <div class="game-status-message">
                Ожидаем начала игры. Игроки могут присоединиться и выбрать команды.
                Во всех командах должен быть хотя бы один игрок.
            </div>
            {% if is_creator %}
            <button class="btn btn-success btn-lg mt-3" id="startGameBtn" onclick="startGame()">Начать игру</button>
            <div id="startGameError" class="alert alert-danger mt-3 d-none"></div>
            {% endif %}
        </div>

        <div id="explainer-ui" class="explainer-ui d-none">
            <h2>Вы объясняете!</h2>
            <div id="current-word-container">
                <p>Ваше слово:</p>
                <div class="word-display" id="current-word">Жмите "СТАРТ"!</div>
            </div>

            <div class="timer-display" id="timer-display">00:00</div>

            <div id="explainer-actions" class="mt-3">
                <button class="btn btn-primary btn-lg" id="startRoundBtn" onclick="startRound()">СТАРТ</button>
                <button class="btn btn-success btn-lg d-none" id="guessedBtn"
                    onclick="handleWordAction('guessed')">Отгадано!</button>
                <button class="btn btn-warning btn-lg d-none" id="skipBtn"
                    onclick="handleWordAction('skip')">Пропустить</button>
            </div>
            <div class="mt-3">
                <button class="btn btn-outline-danger btn-sm" id="forceEndRoundBtn" onclick="forceEndRound()"
                    style="display: none;">
                    Завершить раунд принудительно
                </button>
            </div>
        </div>

        <div id="guesser-ui" class="text-center mt-4 d-none">
            <div class="game-status-message">
                Объясняет <strong id="guesser-explainer-name">...</strong> из команды <strong
                    id="guesser-explainer-team">...</strong>.
                <p>Таймер: <strong id="guesser-timer-display">00:00</strong></p>
            </div>
        </div>

    </div>

    <!-- Модальное окно для редактирования названия команды -->
    <div class="modal fade" id="teamNameModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Изменение названия команды</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-team-name" class="form-label">Новое название команды:</label>
                        <input type="text" class="form-control" id="modal-team-name" maxlength="50"
                            placeholder="Введите новое название">
                        <div class="form-text">Название должно быть от 2 до 50 символов</div>
                    </div>
                    <input type="hidden" id="modal-team-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveTeamName()">Сохранить изменения</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roomId = "{{ room.id }}";
        const myTelegramUserId = document.getElementById('telegram-user-id').value;
        const myTelegramUsername = document.getElementById('telegram-username').value;
        const myPlayerId = document.getElementById('my-player-id').value;
        const isCreator = document.getElementById('is-creator').value === 'True';
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        const ROUND_DURATION_SECONDS = Number(document.getElementById('room-container').dataset.roundDuration) || 60;
        let gameUpdateInterval;
        let timerInterval;
        let teamNameModal = null;
        let teamSelectionModal = null;
        let needsTeamSelection = false;

        function checkTeamSelection() {
            // Проверяем, есть ли у игрока команда
            fetch(`/room/${roomId}/state/?tg_user_id=${myTelegramUserId}&tg_username=${myTelegramUsername}`, {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.my_team_id && room.status !== 'finished') {
                        // У игрока нет команды, показываем модальное окно
                        needsTeamSelection = true;
                        showTeamSelectionModal(data.teams);
                    }
                })
                .catch(error => console.error('Error checking team:', error));
        }

        function showTeamSelectionModal(teams) {
            const container = document.getElementById('team-selection-options');
            container.innerHTML = '';

            teams.forEach(team => {
                const playerCount = team.players.length;
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                button.innerHTML = `
            <div>
                <strong>${escapeHtml(team.name)}</strong>
                <div class="small text-muted">Очки: ${team.score}</div>
            </div>
            <span class="badge bg-primary rounded-pill">${playerCount} игрок${playerCount === 1 ? '' : (playerCount >= 2 && playerCount <= 4 ? 'а' : 'ов')}</span>
        `;
                button.onclick = () => selectTeamForNewPlayer(team.id, team.name);
                container.appendChild(button);
            });

            // Показываем модальное окно
            if (teamSelectionModal) {
                teamSelectionModal.show();
            }
        }


        function selectTeamForNewPlayer(teamId, teamName) {
            const errorDiv = document.getElementById('team-selection-error');
            errorDiv.classList.add('d-none');

            const formData = new FormData();
            formData.append('team_id', teamId);
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/select_team/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Закрываем модальное окно
                        if (teamSelectionModal) {
                            teamSelectionModal.hide();
                        }
                        needsTeamSelection = false;
                        showToast(`Вы присоединились к команде "${teamName}"`, 'success');
                        getGameState(); // Обновляем состояние
                    } else {
                        errorDiv.textContent = data.message || 'Ошибка при выборе команды';
                        errorDiv.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    errorDiv.textContent = 'Ошибка сети. Попробуйте еще раз.';
                    errorDiv.classList.remove('d-none');
                    console.error('Error selecting team:', error);
                });
        }

        function forceEndRound() {
            if (!confirm('Вы уверены, что хотите принудительно завершить раунд?')) {
                return;
            }

            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/end_round_timer/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('Раунд завершен', 'success');
                        getGameState();
                    } else {
                        showToast(data.message || 'Ошибка при завершении раунда', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error forcing end round:', error);
                    showToast('Ошибка сети', 'danger');
                });
        }


        // Инициализация модального окна после загрузки DOM
        document.addEventListener('DOMContentLoaded', function () {
            const modalElement = document.getElementById('teamNameModal');
            if (modalElement) {
                teamNameModal = new bootstrap.Modal(modalElement);
            }
            const teamModalElement = document.getElementById('teamSelectionModal');
            if (teamModalElement) {
                teamSelectionModal = new bootstrap.Modal(teamModalElement);
            }
            checkTeamSelection();
        });

        function copyRoomId() {
            const roomIdText = document.getElementById('room-id-display').textContent;
            navigator.clipboard.writeText(roomIdText).then(() => {
                alert('ID комнаты скопирован: ' + roomIdText);
            }).catch(err => {
                console.error('Не удалось скопировать текст: ', err);
            });
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay(seconds) {
            // Проверяем что seconds валидное число
            if (isNaN(seconds) || seconds < 0) {
                seconds = 0;
            }

            const formattedTime = formatTime(seconds);
            document.getElementById('timer-display').textContent = formattedTime;
            document.getElementById('guesser-timer-display').textContent = formattedTime;
        }

        function startClientTimer(initialTime) {
            let timeLeft = initialTime;
            clearInterval(timerInterval);

            // Убедитесь что timeLeft не отрицательное
            if (timeLeft < 0) timeLeft = 0;
            updateTimerDisplay(timeLeft);

            timerInterval = setInterval(() => {
                timeLeft--;

                // Если время вышло, останавливаем таймер
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    updateTimerDisplay(0);

                    // ТОЛЬКО если текущий игрок - объясняющий, отправляем сигнал
                    const isCurrentExplainer = document.querySelector('[data-is-current-explainer]');
                    if (isCurrentExplainer && isCurrentExplainer.dataset.isCurrentExplainer === 'true') {
                        fetch(`/room/${roomId}/end_round_timer/`, {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `tg_user_id=${myTelegramUserId}&tg_username=${myTelegramUsername}`
                        })
                            .then(response => {
                                if (!response.ok) {
                                    console.error('Error ending round:', response.statusText);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.status === 'success') {
                                    console.log('Round ended successfully');
                                    // Обновляем состояние через 1 секунду
                                    setTimeout(getGameState, 1000);
                                }
                            })
                            .catch(error => console.error('Error sending timer end:', error));
                    }
                    return; // Выходим из интервала
                }

                updateTimerDisplay(timeLeft);
            }, 1000);
        }

        // Функция для открытия модального окна редактирования названия команды
        function editTeamName(teamId, currentName) {
            if (!isCreator) return;

            // Заполняем поля модального окна
            document.getElementById('modal-team-id').value = teamId;
            document.getElementById('modal-team-name').value = currentName;

            // Показываем модальное окно
            if (teamNameModal) {
                teamNameModal.show();

                // Фокусируемся на поле ввода после отображения модального окна
                setTimeout(() => {
                    const inputField = document.getElementById('modal-team-name');
                    if (inputField) {
                        inputField.focus();
                        inputField.select();
                    }
                }, 100);
            }
        }

        // Функция для сохранения нового названия команды
        function saveTeamName() {
            const teamId = document.getElementById('modal-team-id').value;
            const newName = document.getElementById('modal-team-name').value.trim();

            // Валидация
            if (!newName || newName.length < 2 || newName.length > 50) {
                alert('Название команды должно быть от 2 до 50 символов.');
                return;
            }

            // Создаем FormData для отправки (ваш view ожидает FormData)
            const formData = new URLSearchParams();
            formData.append('team_id', teamId);
            formData.append('new_name', newName);
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            // Отправляем запрос на сервер
            fetch(`/room/${roomId}/update_team_name/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || response.statusText);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Закрываем модальное окно
                        if (teamNameModal) {
                            teamNameModal.hide();
                        }

                        // Обновляем состояние игры
                        getGameState();

                        // Показываем уведомление об успехе
                        showToast('Название команды успешно изменено!', 'success');
                    } else {
                        alert(data.message || 'Ошибка при обновлении имени команды.');
                    }
                })
                .catch(error => {
                    console.error('Error updating team name:', error);
                    alert('Ошибка при обновлении имени команды. Проверьте консоль для подробностей.');
                });
        }

        // Вспомогательная функция для показа уведомлений
        function showToast(message, type = 'info') {
            // Создаем элемент для toast
            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            // Создаем контейнер для toast, если его нет
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            // Добавляем toast
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            // Показываем toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();

            // Удаляем toast после скрытия
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        // Вспомогательная функция для экранирования HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderGameState(state) {
            document.getElementById('game-status-text').textContent = state.status === 'waiting' ? 'Ожидание игроков' : (state.status === 'playing' ? 'Идет игра' : 'Игра завершена');
            document.getElementById('current-round').textContent = state.current_round;
            document.getElementById('current-team-name').textContent = state.current_team_name;
            document.getElementById('current-explainer-username').textContent = state.current_explainer_username;
            document.getElementById('players-in-room-count').textContent = state.players_in_room_count;

            if (!state.my_team_id && state.status === 'waiting' && !needsTeamSelection) {
                // Если у игрока нет команды и игра еще не началась, показываем выбор
                setTimeout(() => {
                    showTeamSelectionModal(state.teams);
                }, 1000); // Небольшая задержка для плавности
            }

            if (state.status === 'playing' && state.is_current_explainer) {
                // Показываем кнопку принудительного завершения если время почти вышло
                const forceEndBtn = document.getElementById('forceEndRoundBtn');
                if (state.time_remaining <= 10 && state.time_remaining > 0) {
                    forceEndBtn.style.display = 'block';
                } else {
                    forceEndBtn.style.display = 'none';
                }
            }

            // Scoreboard
            const scoreboardDiv = document.getElementById('scoreboard');
            scoreboardDiv.innerHTML = '';
            state.teams.forEach(team => {
                const teamCard = document.createElement('div');
                teamCard.className = `col-md-6 team-score-card ${state.current_team_name === team.name ? 'active-team' : ''}`;

                let playersHtml = team.players.map(p => `
                    <li>
                        ${p.telegram_username} 
                        ${p.id == myPlayerId ? '(Вы)' : ''}
                        ${p.telegram_username == state.current_explainer_username ? '(Объясняет)' : ''}
                        ${team.id === state.my_team_id && p.id == myPlayerId ? '<span class="text-success">(Ваша команда)</span>' : ''}
                        
                        ${!state.my_team_id && p.id == myPlayerId ?
                        '<span class="text-warning">(Без команды - выберите команду выше)</span>' :
                        `<button class="btn btn-outline-info btn-sm btn-small-player-action ms-2" 
                                    onclick="selectTeam('${team.id}')" 
                                    ${p.id == myPlayerId && team.id === state.my_team_id ? 'disabled' : ''}>
                                    ${p.id == myPlayerId && team.id === state.my_team_id ? 'В команде' : 'Присоединиться'}
                            </button>`
                    }
                    </li>`).join('');

                let teamNameHtml = '';
                if (isCreator && state.status === 'waiting') {
                    // Показываем название команды и кнопку редактирования
                    teamNameHtml = `
                        <div class="team-name-edit-container">
                            <h5 class="team-name-display mb-0">${escapeHtml(team.name)}</h5>
                            <button class="btn btn-outline-secondary btn-team-edit" 
                                    type="button" 
                                    onclick="editTeamName('${team.id}', '${escapeHtml(team.name)}')"
                                    title="Изменить название команды">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    `;
                } else {
                    teamNameHtml = `<h5 class="team-name-display mb-2">${escapeHtml(team.name)}</h5>`;
                }

                teamCard.innerHTML = `
                    ${teamNameHtml}
                    <p>Очки: <strong>${team.score}</strong></p>
                    <ul class="list-unstyled">
                        ${playersHtml}
                    </ul>
                `;
                scoreboardDiv.appendChild(teamCard);
            });

            // Game state specific UI
            const gameFinishedDiv = document.getElementById('game-finished');
            const gameWaitingStateDiv = document.getElementById('game-waiting-state');
            const explainerUiDiv = document.getElementById('explainer-ui');
            const guesserUiDiv = document.getElementById('guesser-ui');
            const startGameBtn = document.getElementById('startGameBtn');
            const startGameError = document.getElementById('startGameError');
            const withoutTeamContainer = document.getElementById('players-without-team-container');
            const withoutTeamList = document.getElementById('players-without-team-list');
            const explainerUI = document.getElementById('explainer-ui');
            if (explainerUI) {
                explainerUI.setAttribute('data-is-current-explainer', state.is_current_explainer.toString());
            }

            // Собираем всех игроков без команды
            const allPlayers = [];
            state.teams.forEach(team => {
                team.players.forEach(player => {
                    allPlayers.push({ ...player, teamName: team.name });
                });
            });

            // Находим игроков без команды (тех, у кого my_team_id не соответствует ни одной команде)
            // Это сложная логика, упростим - покажем предупреждение если у игрока нет команды
            if (!state.my_team_id && state.status === 'waiting') {
                // У текущего игрока нет команды
                withoutTeamContainer.style.display = 'block';
                withoutTeamList.innerHTML = `
            <li class="text-warning">
                <strong>Вы</strong> - выберите команду для участия в игре
                <button class="btn btn-sm btn-outline-warning ms-2" onclick="showTeamSelectionModal(state.teams)">
                    Выбрать команду
                </button>
            </li>
        `;
            } else {
                withoutTeamContainer.style.display = 'none';
            }

            // Скрыть все по умолчанию
            gameFinishedDiv.classList.add('d-none');
            gameWaitingStateDiv.classList.add('d-none');
            explainerUiDiv.classList.add('d-none');
            guesserUiDiv.classList.add('d-none');

            if (state.game_finished) {
                gameFinishedDiv.classList.remove('d-none');
                document.getElementById('winning-team-name').textContent = state.winning_team_name;
                clearInterval(gameUpdateInterval); // Остановить обновление
                clearInterval(timerInterval); // Остановить таймер
                updateTimerDisplay(0); // Сбросить таймер
            } else if (state.status === 'waiting') {
                gameWaitingStateDiv.classList.remove('d-none');
                if (isCreator && state.players_in_room_count > 0 && state.players_in_room_count >= state.num_teams) {
                    startGameBtn.classList.remove('d-none');
                    startGameError.classList.add('d-none');
                } else if (isCreator) {
                    startGameBtn.classList.add('d-none');
                    startGameError.classList.remove('d-none');
                    if (state.players_in_room_count < state.num_teams) {
                        startGameError.textContent = `Необходимо хотя бы по одному игроку в каждой из ${state.num_teams} команд. Сейчас игроков: ${state.players_in_room_count}.`;
                    } else {
                        startGameError.textContent = `Чтобы начать игру, пригласите больше игроков и распределите по командам.`;
                    }
                }
                clearInterval(timerInterval); // Остановить таймер
                updateTimerDisplay(0);
            } else if (state.status === 'playing') {
                if (state.is_current_explainer) {
                    explainerUiDiv.classList.remove('d-none');
                    if (state.current_word) {
                        document.getElementById('current-word-container').style.display = 'block';
                        document.getElementById('current-word').textContent = state.current_word;
                        document.getElementById('startRoundBtn').classList.add('d-none');
                        document.getElementById('guessedBtn').classList.remove('d-none');
                        document.getElementById('skipBtn').classList.remove('d-none');

                        // Убедитесь что time_remaining корректен
                        let timeRemaining = state.time_remaining;
                        if (timeRemaining < 0) timeRemaining = 0;
                        if (timeRemaining > ROUND_DURATION_SECONDS) timeRemaining = ROUND_DURATION_SECONDS;

                        startClientTimer(timeRemaining);
                    } else {
                        document.getElementById('current-word-container').style.display = 'none';
                        document.getElementById('current-word').textContent = 'Жмите "СТАРТ"!';
                        document.getElementById('startRoundBtn').classList.remove('d-none');
                        document.getElementById('guessedBtn').classList.add('d-none');
                        document.getElementById('skipBtn').classList.add('d-none');
                        clearInterval(timerInterval);
                        updateTimerDisplay(ROUND_DURATION_SECONDS);
                    }
                } else {
                    guesserUiDiv.classList.remove('d-none');
                    document.getElementById('guesser-explainer-name').textContent = state.current_explainer_username;
                    document.getElementById('guesser-explainer-team').textContent = state.current_team_name;

                    // Убедитесь что time_remaining корректен для угадывающих
                    let timeRemaining = state.time_remaining;
                    if (timeRemaining < 0) timeRemaining = 0;
                    if (timeRemaining > ROUND_DURATION_SECONDS) timeRemaining = ROUND_DURATION_SECONDS;

                    startClientTimer(timeRemaining);
                }
            }
        }

        // Добавьте в room.html в секцию <script>
        let serverTimeOffset = 0;

        // Функция для вычисления смещения времени сервера
        function calculateTimeOffset(serverTimeStr) {
            const serverTime = new Date(serverTimeStr);
            const clientTime = new Date();
            return serverTime - clientTime;
        }

        function getGameState() {
            fetch(`/room/${roomId}/state/?tg_user_id=${myTelegramUserId}&tg_username=${myTelegramUsername}`, {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(data => {
                    // Вычисляем смещение времени при первом запросе
                    if (data.server_time && serverTimeOffset === 0) {
                        serverTimeOffset = calculateTimeOffset(data.server_time);
                    }
                    renderGameState(data);
                })
                .catch(error => console.error('Error fetching game state:', error));
        }

        // Функция для получения синхронизированного времени
        function getSyncedTime() {
            return new Date(Date.now() + serverTimeOffset);
        }

        function selectTeam(teamId) {
            const formData = new FormData();
            formData.append('team_id', teamId);
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/select_team/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                    } else {
                        alert(data.message || 'Ошибка при выборе команды.');
                    }
                })
                .catch(error => console.error('Error selecting team:', error));
        }

        function startGame() {
            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/start_game/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                    } else {
                        document.getElementById('startGameError').classList.remove('d-none');
                        document.getElementById('startGameError').textContent = data.message || 'Ошибка при начале игры.';
                    }
                })
                .catch(error => console.error('Error starting game:', error));
        }

        function startRound() {
            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/start_round/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                    } else {
                        alert(data.message || 'Ошибка при начале раунда.');
                    }
                })
                .catch(error => console.error('Error starting round:', error));
        }

        function handleWordAction(action) { // 'guessed' or 'skip'
            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/${action}/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        if (data.game_over) {
                            // Игра закончилась, просто обновить состояние
                            getGameState();
                        } else if (data.next_turn) {
                            // Слова закончились в раунде, сервер переключил ход
                            getGameState();
                        } else {
                            // Обычный ход, новое слово или текущее
                            getGameState();
                        }
                    } else {
                        alert(data.message || `Ошибка при выполнении действия "${action}".`);
                    }
                })
                .catch(error => console.error(`Error handling word action ${action}:`, error));
        }

        function resetGame() {
            if (!confirm('Вы уверены, что хотите сбросить игру и начать новую?')) {
                return;
            }
            const formData = new FormData();
            formData.append('tg_user_id', myTelegramUserId);
            formData.append('tg_username', myTelegramUsername);

            fetch(`/room/${roomId}/reset_game/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        getGameState(); // Обновить состояние
                        clearInterval(gameUpdateInterval);
                        gameUpdateInterval = setInterval(getGameState, 4000); // Перезапустить интервал
                    } else {
                        let retryDelay = 2000;
                        function getGameStateWithRetry() {
                            getGameState().catch(error => {
                                console.error('Error fetching game state:', error);
                                retryDelay = Math.min(retryDelay * 1.5, 30000); // Максимум 30 секунд
                                setTimeout(getGameStateWithRetry, retryDelay);
                            }).finally(() => {
                                retryDelay = 4000; // Сброс после успеха
                            });
                        }
                    }
                })
                .catch(error => console.error('Error resetting game:', error));
        }

        // Обработка нажатия Enter в модальном окне
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && document.getElementById('teamNameModal').classList.contains('show')) {
                saveTeamName();
            }
        });

        // Инициализация
        document.addEventListener('DOMContentLoaded', function () {
            getGameState(); // Получить начальное состояние
            gameUpdateInterval = setInterval(getGameState, 3000); // Обновлять каждые 2 секунды
        });
    </script>
</body>

</html>